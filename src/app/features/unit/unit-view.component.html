<div>
  <!-- Loading state -->
  <div *ngIf="loading()" class="flex items-center justify-center py-12">
    <span class="loading loading-spinner loading-lg"></span>
  </div>

  <!-- Error state -->
  <div *ngIf="error() && !loading()" class="alert alert-error mb-4">
    <span>{{ error() }}</span>
  </div>

  <!-- Unit Details -->
  <div *ngIf="!loading() && !error() && unit() as unit" class="space-y-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold text-base-content">
        {{ 'unit.title' | translate }} #{{ unit.id }}
      </h1>
      <div class="flex gap-2">
        <a
          *ngIf="showStartFlowButton()"
          [routerLink]="['/unit', unit.id]"
          [queryParams]="{ debug: 'true', 'flow-start': 'true' }"
          class="btn btn-secondary"
        >
          {{ 'flow.start.button' | translate }}
        </a>
        <a [routerLink]="['/unit', unit.id, 'edit']" class="btn btn-primary">
          {{ 'common.edit' | translate }}
        </a>
        <a [routerLink]="['/unit']" class="btn btn-outline text-base-content">
          {{ 'common.close' | translate }}
        </a>
      </div>
    </div>

    <div class="card bg-base-200 shadow border border-base-300">
      <div class="card-body">
        <div class="space-y-4">
          <div>
            <label class="label">
              <span class="label-text text-base-content font-medium">{{ 'unit.id' | translate }}</span>
            </label>
            <div class="text-base-content text-lg">{{ unit.id }}</div>
          </div>
          <div>
            <label class="label">
              <span class="label-text text-base-content font-medium">{{ 'unit.status' | translate }}</span>
            </label>
            <div>
              <span class="badge badge-lg" [ngClass]="getStatusClass(unit.status)">
                {{ getStatusText(unit.status) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Communication history -->
    <div class="card bg-base-200 shadow border border-base-300 mt-4">
      <div class="card-body">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-base-content">
            Unit flows
          </h2>
          <div class="text-sm text-base-content/70">
            SignalR: 
            <span [class]="flowsConnected() ? 'text-success' : 'text-error'">
              {{ flowsConnected() ? 'Connected' : 'Disconnected' }}
            </span>
          </div>
        </div>

        <div *ngIf="aiStatusLoading()" class="flex items-center justify-center py-6">
          <span class="loading loading-spinner loading-md"></span>
        </div>

        <div *ngIf="aiStatusError() && !aiStatusLoading()" class="alert alert-warning mb-2">
          <span>{{ aiStatusError() }}</span>
        </div>

        <div *ngIf="!aiStatusLoading() && !aiStatusError()">
          <div *ngIf="aiStatus().length === 0" class="text-sm text-base-content/70">
            No AI communication runs for this unit yet.
          </div>

          <div *ngIf="aiStatus().length > 0" class="overflow-x-auto">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th class="text-base-content">Instance ID</th>
                  <th class="text-base-content">Status</th>
                  <th class="text-base-content">Created</th>
                  <th class="text-base-content">Last updated</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let inst of aiStatus()" class="hover">
                  <td class="font-mono text-xs">
                    <a
                      [routerLink]="['/unit', unitId(), 'instance', inst.instanceId]"
                      class="link link-primary text-base-content hover:text-primary"
                      [attr.title]="'View instance details'"
                    >
                      {{ inst.instanceId }}
                    </a>
                  </td>
                  <td class="text-base-content">
                    <span class="badge badge-outline">
                      {{ inst.runtimeStatus }}
                    </span>
                  </td>
                  <td class="text-base-content">{{ inst.createdTime | date: 'short' }}</td>
                  <td class="text-base-content">{{ inst.lastUpdatedTime | date: 'short' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Flow Modal -->
  <app-start-flow-modal
    *ngIf="showStartFlowModal()"
    [isOpen]="showStartFlowModal()"
    [unitId]="unitId()"
    (close)="closeStartFlowModal()"
    (flowStarted)="onFlowStarted($event)"
  ></app-start-flow-modal>
</div>

